{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block extra_head %}
{# Pindahkan link CSS ke block terpisah agar base template lebih rapi #}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
<style>
    /* Sembunyikan baris form yang ditandai untuk dihapus */
    .item-form.deleted {
        display: none;
    }
</style>
{% endblock %}


{% block content %}
<form method="post" novalidate>
    {% csrf_token %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>{{ title }}</h1>
        <div>
            <a href="{% url 'purchases:purchase_list' %}" class="btn btn-secondary">Batal</a>
            <button type="submit" class="btn btn-success"><i class="bi bi-check-circle"></i> Simpan Purchase Order</button>
        </div>
    </div>
    
    {% if form.errors or formset.errors %}
    <div class="alert alert-danger">
        <strong>Error:</strong> Harap perbaiki kesalahan di bawah ini.
        <ul>
            {% for error in form.non_field_errors %}<li>{{ error }}</li>{% endfor %}
            {% for error in formset.non_form_errors %}<li>{{ error }}</li>{% endfor %}
        </ul>
    </div>
    {% endif %}

    <div class="card mb-4">
        <div class="card-header">Detail Purchase Order</div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">{{ form.vendor.label_tag }} {{ form.vendor }}</div>
                <div class="col-md-6 mb-3">{{ form.status.label_tag }} {{ form.status }}</div>
                <div class="col-md-6 mb-3">{{ form.order_date.label_tag }} {{ form.order_date }}</div>
                <div class="col-md-6 mb-3">{{ form.expected_delivery_date.label_tag }} {{ form.expected_delivery_date }}</div>
                <div class="col-12 mb-3">{{ form.notes.label_tag }} {{ form.notes }}</div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">Item Pembelian</div>
        <div class="card-body">
            {{ formset.management_form }}
            <div id="item-formset">
                <table class="table align-middle">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 50%;">Item</th>
                            <th style="width: 15%;">Jumlah</th>
                            <th style="width: 25%;">Harga Satuan</th>
                            <th style="width: 10%;" class="text-center">Aksi</th>
                        </tr>
                    </thead>
                    <tbody class="item-form-container">
                        {% for form in formset %}
                        {# PERBAIKAN: Wrapper div untuk setiap baris form #}
                        <tr class="item-form">
                            {{ form.id }}
                            <td class="pt-3">{{ form.item }}{% for error in form.item.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}</td>
                            <td class="pt-3">{{ form.quantity }}{% for error in form.quantity.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}</td>
                            <td class="pt-3">{{ form.unit_price }}{% for error in form.unit_price.errors %}<div class="text-danger small">{{ error }}</div>{% endfor %}</td>
                            <td class="text-center">
                                {# PERBAIKAN: Tombol hapus yang konsisten untuk semua baris #}
                                <button type="button" class="btn btn-sm btn-outline-danger remove-item-btn">Hapus</button>
                                {% if form.instance.pk %}{{ form.DELETE }}{% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <button type="button" id="add-item-btn" class="btn btn-outline-primary mt-2">
                <i class="bi bi-plus"></i> Tambah Item
            </button>
        </div>
    </div>
</form>

<table style="display: none;">
    <tbody id="empty-form-template">
        <tr class="item-form">
            {{ formset.empty_form.id }}
            <td class="pt-3">{{ formset.empty_form.item }}</td>
            <td class="pt-3">{{ formset.empty_form.quantity }}</td>
            <td class="pt-3">{{ formset.empty_form.unit_price }}</td>
            <td class="text-center">
                <button type="button" class="btn btn-sm btn-outline-danger remove-item-btn">Hapus</button>
                {# Checkbox DELETE tidak diperlukan di template kosong #}
            </td>
        </tr>
    </tbody>
</table>

{% endblock %}

{% block scripts %}
{# PERBAIKAN: Seluruh blok JavaScript ditulis ulang agar lebih solid #}
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function() {
    // Fungsi untuk inisialisasi Select2 pada elemen tertentu
    function initializeSelect2(element) {
        $(element).select2({
            theme: 'bootstrap-5',
            placeholder: 'Cari item...',
            minimumInputLength: 1,
            ajax: {
                url: "{% url 'purchases:item_autocomplete' %}",
                dataType: 'json',
                delay: 250,
                data: function (params) { return { q: params.term }; },
                processResults: function (data) { return { results: data }; },
                cache: true
            }
        }).on('select2:select', function (e) {
            var data = e.params.data;
            // Isi otomatis harga satuan berdasarkan harga beli terakhir item
            $(this).closest('.item-form').find('input[name$="-unit_price"]').val(data.buy_price || '0.00');
        });
    }

    // Inisialisasi Select2 untuk semua baris yang sudah ada saat halaman dimuat
    $('.item-form-container .item-select').each(function() {
        initializeSelect2(this);
    });

    // Event handler untuk tombol 'Tambah Item'
    $('#add-item-btn').on('click', function(e) {
        e.preventDefault();
        const formsetContainer = $('.item-form-container');
        const formsetPrefix = '{{ formset.prefix }}';
        const totalFormsInput = $(`#id_${formsetPrefix}-TOTAL_FORMS`);
        let formIndex = parseInt(totalFormsInput.val());

        // Kloning template, ganti __prefix__ dengan nomor indeks baru
        let newFormHtml = $('#empty-form-template').html().replace(/__prefix__/g, formIndex);
        formsetContainer.append(newFormHtml);

        // Inisialisasi Select2 pada baris baru
        initializeSelect2($(`#id_${formsetPrefix}-${formIndex}-item`));

        // Update jumlah total form
        totalFormsInput.val(formIndex + 1);
    });

    // Event handler untuk tombol 'Hapus' pada setiap baris
    // Menggunakan event delegation agar berfungsi juga untuk baris yang baru ditambah
    $('.item-form-container').on('click', '.remove-item-btn', function(e) {
        e.preventDefault();
        const row = $(this).closest('.item-form');
        const deleteInput = row.find('input[type="checkbox"][name$="-DELETE"]');

        if (deleteInput.length) {
            // Jika ini adalah baris yang sudah ada (punya checkbox DELETE)
            // Centang checkboxnya dan sembunyikan barisnya
            deleteInput.prop('checked', true);
            row.addClass('deleted'); // Sembunyikan via CSS
        } else {
            // Jika ini adalah baris baru (belum disimpan)
            // Hapus saja elemennya dari DOM
            row.remove();
            
            // Perlu update ulang nomor total form agar tidak ada gap
            const totalFormsInput = $('#id_{{ formset.prefix }}-TOTAL_FORMS');
            totalFormsInput.val(parseInt(totalFormsInput.val()) - 1);
        }
    });
});
</script>
{% endblock %}